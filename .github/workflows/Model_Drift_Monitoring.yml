name: MLOps Pipeline For Monitoring Model Drift

on:
  workflow_dispatch:
    inputs:
      run_option:
        description: 'Chọn chế độ: all (chạy toàn bộ pipeline)'
        required: true
        default: 'all'
        type: choice
        options:

          - all
          - provision
          - dataset
          - train
          - test
          - clean_infra
           
          
run-name: >
  Monitoring Model Drift #${{ github.run_number }}: 


jobs:
  test_deep_learning_model:
    runs-on: ubuntu-latest
    steps:
    - name: Set up SSH key
      run: |
        echo "${{ secrets.EMR_KEY }}" > emr.pem
        chmod 600 emr.pem
    - name: SSH to EC2 and run training
      run: |
        ssh -i "emr.pem" -o StrictHostKeyChecking=no ubuntu@${{ vars.HOST }} << 'EOF'
          cd /home/ubuntu/kltn-sentiment-monitoring-mlops || exit
          python3 src/_04_monitoring_test.py
        EOF


  notify_success:
    if: ${{ success() }}
    runs-on: ubuntu-latest
    needs: [test_deep_learning_model]
    steps:
    - name: Send success email
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "Model Drift Monitoring Success"
        body: |
          ✅ The MLOps pipeline for monitoring model drift has completed successfully.
        
          🛠 Workflow: ${{ github.workflow }}
          💼 Job: ${{ github.job }}
          🌿 Branch: ${{ github.ref_name }}
          🔀 Commit: ${{ github.sha }}
          🧾 Commit Message: ${{ github.event.head_commit.message }}
          👤 Commit Author: ${{ github.event.head_commit.author.name }}
        
          📅 Run Started At: ${{ github.event.repository.updated_at }}
          📄 View Logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
         
        to: ${{ secrets.NOTIFY_EMAIL }}
        from: ${{ secrets.EMAIL_USERNAME }}
        

  notify_failure:
    if: ${{ failure() }}
    runs-on: ubuntu-latest
    needs: [test_deep_learning_model]
    steps:
    - name: Send failure email
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "Model Drift Monitoring Failure"
        body: |
            ❌ The MLOps pipeline for monitoring model drift has failed.

            🛠 Workflow: ${{ github.workflow }}
            💼 Job: ${{ github.job }}
            🌿 Branch: ${{ github.ref_name }}
            🔀 Commit: ${{ github.sha }}
            🧾 Commit Message: ${{ github.event.head_commit.message }}
            👤 Commit Author: ${{ github.event.head_commit.author.name }}
          
            📅 Run Started At: ${{ github.event.repository.updated_at }}
            🛠 Please check the logs and fix any issues.
            📄 View Logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        to: ${{ secrets.NOTIFY_EMAIL }}
        from: ${{ secrets.EMAIL_USERNAME }}
